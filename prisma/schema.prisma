// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum UserRole {
  citizen
  admin
  ward_officer
  maintenance
}

enum Language {
  en
  hi
  ml
}

model User {
  id                     String   @id @default(cuid())
  name                   String
  email                  String   @unique
  phone                  String
  password               String
  role                   UserRole @default(citizen)
  ward                   String?
  department            String?
  avatar                String?
  
  // Preferences
  language              Language @default(en)
  notificationsEnabled  Boolean  @default(true)
  emailAlerts           Boolean  @default(true)
  
  isActive              Boolean  @default(true)
  lastLogin             DateTime?
  resetPasswordToken    String?
  resetPasswordExpire   DateTime?
  emailVerificationToken String?
  isEmailVerified       Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  submittedComplaints   Complaint[] @relation("SubmittedBy")
  assignedComplaints    Complaint[] @relation("AssignedTo")
  remarks               Remark[]
  notifications         Notification[]
  
  @@map("users")
}

enum ComplaintType {
  Water_Supply
  Electricity
  Road_Repair
  Garbage_Collection
  Street_Lighting
  Sewerage
  Public_Health
  Traffic
  Others
}

enum ComplaintStatus {
  registered
  assigned
  in_progress
  resolved
  closed
  reopened
}

enum Priority {
  low
  medium
  high
  critical
}

model Complaint {
  id                      String          @id @default(cuid())
  complaintId             String          @unique
  type                    ComplaintType
  description             String
  
  // Contact Info as separate fields for better querying
  contactMobile           String
  contactEmail            String?
  
  // Location
  ward                    String
  area                    String
  address                 String?
  latitude                Float?
  longitude               Float?
  landmark                String?
  
  status                  ComplaintStatus @default(registered)
  priority                Priority        @default(medium)
  
  submittedById           String?
  submittedBy             User?           @relation("SubmittedBy", fields: [submittedById], references: [id])
  
  assignedToId            String?
  assignedTo              User?           @relation("AssignedTo", fields: [assignedToId], references: [id])
  assignedAt              DateTime?
  
  slaDeadline             DateTime
  resolvedAt              DateTime?
  closedAt                DateTime?
  
  isAnonymous             Boolean         @default(false)
  
  // Feedback
  feedbackRating          Int?
  feedbackComment         String?
  feedbackSubmittedAt     DateTime?
  
  tags                    String          @default("") // Store as comma-separated string
  category                String          @default("general")
  escalationLevel         Int             @default(0)
  estimatedResolutionTime Int             @default(72) // in hours
  
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  
  // Relations
  files                   File[]
  remarks                 Remark[]
  
  @@map("complaints")
}

model File {
  id           String    @id @default(cuid())
  filename     String
  originalName String
  mimetype     String
  size         Int
  url          String
  uploadedAt   DateTime  @default(now())
  
  complaintId  String
  complaint    Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  
  @@map("files")
}

enum RemarkType {
  status_update
  assignment
  general
  closure
  reopen
}

model Remark {
  id          String     @id @default(cuid())
  text        String
  type        RemarkType @default(general)
  addedAt     DateTime   @default(now())
  
  addedById   String
  addedBy     User       @relation(fields: [addedById], references: [id])
  
  complaintId String
  complaint   Complaint  @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  
  @@map("remarks")
}

enum NotificationType {
  complaint_submitted
  complaint_assigned
  complaint_updated
  complaint_resolved
  complaint_closed
  sla_warning
  sla_breach
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional reference to complaint
  complaintId String?
  
  @@map("notifications")
}
