// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                     String   @id @default(cuid())
  name                   String
  email                  String   @unique
  phone                  String
  password               String
  role                   String   @default("citizen") // citizen, admin, ward_officer, maintenance
  ward                   String?
  department            String?
  avatar                String?
  
  // Preferences
  language              String   @default("en") // en, hi, ml
  notificationsEnabled  Boolean  @default(true)
  emailAlerts           Boolean  @default(true)
  
  isActive              Boolean  @default(true)
  lastLogin             DateTime?
  resetPasswordToken    String?
  resetPasswordExpire   DateTime?
  emailVerificationToken String?
  isEmailVerified       Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  submittedComplaints   Complaint[] @relation("SubmittedBy")
  assignedComplaints    Complaint[] @relation("AssignedTo")
  remarks               Remark[]
  notifications         Notification[]
  
  @@map("users")
}

model Complaint {
  id                      String   @id @default(cuid())
  complaintId             String   @unique
  type                    String   // Water_Supply, Electricity, etc.
  description             String
  
  // Contact Info as separate fields for better querying
  contactMobile           String
  contactEmail            String?
  
  // Location
  ward                    String
  area                    String
  address                 String?
  latitude                Real?
  longitude               Real?
  landmark                String?
  
  status                  String   @default("registered") // registered, assigned, in_progress, resolved, closed, reopened
  priority                String   @default("medium") // low, medium, high, critical
  
  submittedById           String?
  submittedBy             User?    @relation("SubmittedBy", fields: [submittedById], references: [id])
  
  assignedToId            String?
  assignedTo              User?    @relation("AssignedTo", fields: [assignedToId], references: [id])
  assignedAt              DateTime?
  
  slaDeadline             DateTime
  resolvedAt              DateTime?
  closedAt                DateTime?
  
  isAnonymous             Boolean  @default(false)
  
  // Feedback
  feedbackRating          Int?
  feedbackComment         String?
  feedbackSubmittedAt     DateTime?
  
  tags                    String   @default("") // Store as comma-separated string
  category                String   @default("general")
  escalationLevel         Int      @default(0)
  estimatedResolutionTime Int      @default(72) // in hours
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  files                   File[]
  remarks                 Remark[]
  
  @@map("complaints")
}

model File {
  id           String    @id @default(cuid())
  filename     String
  originalName String
  mimetype     String
  size         Int
  url          String
  uploadedAt   DateTime  @default(now())
  
  complaintId  String
  complaint    Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  
  @@map("files")
}

model Remark {
  id          String   @id @default(cuid())
  text        String
  type        String   @default("general") // status_update, assignment, general, closure, reopen
  addedAt     DateTime @default(now())
  
  addedById   String
  addedBy     User     @relation(fields: [addedById], references: [id])
  
  complaintId String
  complaint   Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  
  @@map("remarks")
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // complaint_submitted, complaint_assigned, etc.
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional reference to complaint
  complaintId String?
  
  @@map("notifications")
}
